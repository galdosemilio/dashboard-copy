<div class="report-heading">
    <div fxFlex fxLayout="column" fxLayoutAlign="start stretch" fxLayoutGap="15px">
        <div fxLayout="row" fxLayout="start center">
            <mat-icon class="title-icon">receipt</mat-icon>

            <h3 fxLayout="row" fxLayoutAlign="start start" fxLayoutGap="10px">
                <div fxLayout="column" fxLayoutAlign="start start" fxLayoutGap="5px">
                    <span>{{ 'REPORTS.RPM_BILLING_TITLE' | translate }}</span>
                    <small class="count" *ngIf="totalCount"><strong>{{ totalCount }}</strong> {{ 'GLOBAL.PATIENTS' | translate }}</small>
                </div>
                <ccr-walkthrough [autoClose]="false" guide="rpm"></ccr-walkthrough>
            </h3>
        </div>
        <small class="top-level-accout-label" *ngIf="isTopLevelAccount">{{ 'REPORTS.RPM_BILLING_TOP_LEVEL_ACCOUNT' | translate }}</small>
        <div fxFlex fxLayout="column" fxLayoutAlign="end stretch">
            <div class="org-search-container" fxLayout="row" fxLayoutAlign="stretch center" fxLayoutGap="10px">
                <div fxFlex fxLayout="row" fxLayoutAlign="stretch center" fxLayoutGap="10px">
                    <ccr-organization-search fxFlex
                    *ngIf="!selectedClinic"
                    (onSelect)="onSelectClinic($event)"
                    prefixIcon="business">
                    </ccr-organization-search>

                    <ccr-popup-description
                    *ngIf="!selectedClinic"
                    fxFlex="10%"
                    [title]="'BOARD.SELECT_ORGANIZATION' | translate"
                    [description]="'RPM.SELECT_ORGANIZATION_DESCRIPTION' | translate"
                    [showIntro]="false"
                    ></ccr-popup-description>

                    <div *ngIf="selectedClinic" fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="5px">
                        <span class="ccr-text-bold clinic-label">{{ 'BOARD.SELECTED_CLINIC' | translate }}</span>
                        <mat-chip-list>
                            <mat-chip>
                                {{ selectedClinic.name }}
                                <mat-icon (click)="onRemoveClinic()" matChipRemove>cancel</mat-icon>
                            </mat-chip>
                        </mat-chip-list>
                    </div>
                </div>

                <div fxFlex="35%" fxLayout="row" fxLayoutAlign="end start" fxLayoutGap="10px">
                    <button
                    [disabled]="!source.isLoaded || source.isEmpty || source.isLoading || isLoading"
                    (click)="download()"
                    mat-button class="ccr-align-center">
                        {{ 'REPORTS.EXPORT_REPORT' | translate }}
                        <mat-icon>file_download</mat-icon>
                    </button>

                    <button
                    [disabled]="!source.isLoaded || source.isEmpty || source.isLoading || isLoading"
                    (click)="download(true)"
                    mat-button class="ccr-align-center">
                        {{ 'RPM.EXPORT_SUPERBILL' | translate }}
                        <mat-icon>file_download</mat-icon>
                    </button>
                </div>
            </div>

            <div fxLayout="row" fxLayoutAlign="stretch end" fxLayoutGap="10px">
                <div fxFlex>
                    <mat-form-field
                    [formGroup]="searchForm"
                    fxFlex
                    class="minus-margin-bottom">
                        <mat-icon class="prefix-icon" matPrefix>person</mat-icon>
                        <input
                        [placeholder]="'BOARD.FILTER_BY_PATIENT_NAME' | translate"
                        formControlName="query"
                        matInput
                        type="text">
                        <mat-icon
                        *ngIf="searchForm?.value.query"
                        (click)="clearSearchForm()"
                        class="clickable"
                        matSuffix>cancel</mat-icon>
                    </mat-form-field>
                </div>

                <div fxFlex="6.5%">&nbsp;</div>

                <div fxFlex="35%" fxLayout="row" fxLayoutAlign="end center" fxLayoutGap="10px">
                    <ccr-page-size-selector
                        [defaultPageSize]="50"
                        [defaultPageSizeStorageKey]="defaultPageSizeStorageKey"
                        [disabled]="!source.isLoaded"
                    ></ccr-page-size-selector>

                    <ccr-paginator fxFlex="nogrow" #paginator
                    [length]="source.total"
                    [pageIndex]="source.pageIndex"
                    [pageSize]="source.pageSize"
                    (page)="source.pageIndex = $event.pageIndex"
                    ></ccr-paginator>
                </div>
            </div>
        </div>
    </div>
</div>

<ccr-datasource-overlay
[emptyMsg]="'BOARD.RPM_ENTRIES_EMPTY_LIST' | translate"
[source]="source"
class="ccr-table ccr-expand-table ccr-table-stats">

<div class="ccr-expandable-table-container">
<div class="ccr-expandable-table" #container (scroll)="onScroll()">
  <table ccrTableSort>
    <caption hidden>{{ 'REPORTS.RPM_BILLING_TITLE' | translate }}</caption>
    <thead [class.sticky-header]="isDesktop">
        <th #columns class="id-cell" [class.sticky-column]="isDesktop">
            #
        </th>

        <th #columns class="first-name-cell" [class.sticky-column]="isDesktop">
            <ccr-table-sort-header property="firstName">
                <span>{{ 'BOARD.FIRST_NAME' | translate }}</span>
            </ccr-table-sort-header>
        </th>

        <th #columns class="last-name-cell" [class.sticky-column]="isDesktop">
            <ccr-table-sort-header property="lastName">
                <span>{{ 'BOARD.LAST_NAME' | translate }}</span>
            </ccr-table-sort-header>
        </th>

        <th #columns>
            {{ 'BOARD.DOB' | translate }}
        </th>

        <th #columns class="device-type-cell">
            {{ 'RPM.DEVICE_TYPE' | translate }}
        </th>

        <th #columns class="diagnosis-cell">
            {{ 'RPM.PRIMARY_DIAGNOSIS' | translate }}
        </th>

        <th #columns class="diagnosis-cell">
            {{ 'RPM.SECONDARY_DIAGNOSIS' | translate }}
        </th>

        <th #columns class="supervising-provider-cell">
            {{ 'GLOBAL.SUPERVISING_PROVIDER' | translate }}
        </th>

        <th #columns class="status-cell">
            <div fxLayout="column" fxLayoutAlign="center center" fxLayoutGap="5px">
                <p>{{ 'BOARD.STATUS' | translate }}</p>
                <select (change)="onStatusFilterChange($event)">
                    <option value="all">{{ 'LIBRARY.FORMS.ALL' | translate }}</option>
                    <option selected value="active">{{ 'RPM.STATE.ACTIVE' | translate }}</option>
                    <option value="inactive">{{ 'RPM.STATE.INACTIVE' | translate }}</option>
                </select>
            </div>
        </th>

        <th #columns class="activation-date-cell">
            <div fxLayout="row" fxLayoutAlign="center center">
                <ccr-table-sort-header property="startedAt">
                    <span>{{ 'RPM.ACTIVATION_DATE' | translate }}</span>
                </ccr-table-sort-header>
            </div>
        </th>

        <th #columns *ngFor="let billingEntry of source.result?.[0]?.billing; let billingIndex = index" class="code-cell">
            <div style="height: 100%" fxLayout="column" fxLayoutAlign="stretch stretch">
                <p class="code-title">{{ billingEntry.code === '99458' ? '99458 x1' : billingEntry.code }}</p>
                <div fxFlex fxLayout="row" fxLayoutAlign="stretch center">
                    <p class="code-subtitle" fxFlex>{{ 'RPM.LATEST_ELIGIBLE_CLAIM' | translate }}</p>
                    <p class="code-subtitle" fxFlex>{{ 'RPM.NEXT_CLAIM' | translate }}</p>
                </div>
            </div>
        </th>

        <th #columns class="code-cell">
            <div style="height: 100%" fxLayout="column" fxLayoutAlign="stretch stretch">
                <p class="code-title">99458 x2</p>
                <div fxLayout="row" fxLayoutAlign="stretch center">
                    <p class="code-subtitle" fxFlex>{{ 'RPM.LATEST_ELIGIBLE_CLAIM' | translate }}</p>
                    <p class="code-subtitle" fxFlex>{{ 'RPM.NEXT_CLAIM' | translate }}</p>
                </div>
            </div>
        </th>
    </thead>

    <tbody>
        <tr
        *ngFor="let row of source.result; let i = index"
        [ngClass]="{
            'row-even': i % 2 === 0,
            'row-odd': i % 2 === 1,
            'last-row': i === source.result.length - 1
          }">
            <td class="id-cell" [class.sticky-column]="isDesktop">
                {{ i + source.criteria.offset + 1 }}
            </td>

            <td class="first-name-cell" [class.sticky-column]="isDesktop">
                <span [accountType]="'3'" [ccrAccountLink]="row.account.id">{{ row.account.firstName }}</span>
            </td>

            <td class="last-name-cell" [class.sticky-column]="isDesktop">
                <span [accountType]="'3'" [ccrAccountLink]="row.account.id">{{ row.account.lastName }}</span>
            </td>

            <td>
                {{ row.account.dateOfBirth | amDateFormat:'MM/DD/YYYY' }}
            </td>

            <td class="device-type-cell">
                {{ row.device?.displayName | translate }}
            </td>

            <td class="diagnosis-cell">
                <ccr-expandable-text *ngIf="row.rpm?.diagnosis?.primary" [text]="row.rpm.diagnosis.primary"></ccr-expandable-text>
            </td>

            <td class="diagnosis-cell">
                <ccr-expandable-text *ngIf="row.rpm?.diagnosis?.secondary" [text]="row.rpm.diagnosis.secondary"></ccr-expandable-text>
            </td>

            <td class="supervising-provider-cell">
                <span *ngIf="row.rpm?.supervisingProvider" [accountType]="'3'" [ccrAccountLink]="row.rpm.supervisingProvider.id">
                    {{ row.rpm.supervisingProvider.firstName }} {{ row.rpm.supervisingProvider.lastName }}
                </span>
            </td>

            <td>
                <div fxLayout="row" fxLayoutAlign="center center">
                    <mat-icon *ngIf="row.rpm.isActive; else inactiveIcon" class="active">
                        check_circle
                    </mat-icon>
                </div>
            </td>

            <td class="activation-date-cell highlighted-cell">
                {{ row.rpm.isActive ? (row.rpm.startedAt | amDateFormat:'MM/DD/YYYY' ) : '' }}
            </td>

            <td *ngFor="let billingEntry of source.result?.[0]?.billing; let billingIndex = index" class="code-cell">
                <div fxLayout="row" fxLayoutAlign="stretch center">
                    <div class="claim-date-subcell" fxFlex fxLayout="row" fxLayoutAlign="center center">
                        <span *ngIf="row.rpm.plan; else empty" class="highlighted-cell">
                            {{ row.billing[billingIndex].eligibility.last?.timestamp | amDateFormat:'MM/DD/YYYY' }}
                        </span>
                        <span *ngIf="!row.rpm.plan && billingIndex < 2" class="no-highlight">{{ 'GLOBAL.NA' | translate }}</span>
                    </div>
                    <div *ngIf="row.rpm.isActive; else emptyDiv" fxFlex fxLayout="row" fxLayoutAlign="center center" fxLayoutGap="10px">
                        <ng-container *ngFor="let codeRequirement of row.billing[billingIndex].eligibility.next?.relatedCodeRequirementsNotMet">
                            <ccr-rpm-dependency-icon
                            [matTooltip]="'RPM.DEPENDENCY_ICON_DESCRIPTION' | translate:{code: codeRequirement}"
                            [size]="40"
                            [text]="codeRequirement">
                            </ccr-rpm-dependency-icon>
                        </ng-container>

                        <span *ngIf="!row.rpm.plan && billingIndex < 2" class="no-next-claim">{{ 'GLOBAL.NA' | translate }}</span>

                        <ccr-rpm-calendar-icon
                        *ngIf="row.billing[billingIndex].remainingDays"
                        [matTooltip]="'RPM.CALENDAR_ICON_DESCRIPTION' | translate:{amount: row.billing[billingIndex].remainingDays}"
                        [size]="40"
                        text="{{ row.billing[billingIndex].remainingDays }}{{ 'UNIT.DAY_CONDENSED' | translate }}">
                        </ccr-rpm-calendar-icon>

                        <ccr-rpm-clock-icon
                        *ngIf="(billingEntry.code !== '99458' || row.billing[billingIndex].eligibility.next?.alreadyEligibleCount < 1) && row.billing[billingIndex].eligibility.next?.monitoring?.remaining"
                        [matTooltip]="'RPM.CLOCK_ICON_DESCRIPTION' | translate:{amount: row.billing[billingIndex].eligibility.next?.monitoring.remaining}"
                        [size]="40"
                        text="{{ row.billing[billingIndex].eligibility.next?.monitoring.remaining }}{{ row.billing[billingIndex].eligibility.next?.monitoring.units | translate }}">
                        </ccr-rpm-clock-icon>

                        <ccr-rpm-scale-icon
                        *ngIf="row.billing[billingIndex].eligibility.next?.transmissions?.remaining"
                        [matTooltip]="'RPM.SCALE_ICON_DESCRIPTION' | translate:{amount: row.billing[billingIndex].eligibility.next?.transmissions.remaining}"
                        [size]="40"
                        text="{{ row.billing[billingIndex].eligibility.next?.transmissions.remaining }}">
                        </ccr-rpm-scale-icon>

                        <ccr-rpm-chat-icon
                        *ngIf="row.billing[billingIndex].eligibility.next?.liveInteraction?.remaining"
                        [matTooltip]="'RPM.CHAT_ICON_DESCRIPTION' | translate:{amount: row.billing[billingIndex].eligibility.next?.liveInteraction.remaining}"
                        [size]="40"
                        text="{{ row.billing[billingIndex].eligibility.next?.liveInteraction.remaining }}">
                        </ccr-rpm-chat-icon>
                    </div>
                </div>
            </td>

            <td class="code-cell">
                <div fxLayout="row" fxLayoutAlign="stretch center">
                    <div class="claim-date-subcell" fxFlex fxLayout="row" fxLayoutAlign="center center">
                        <span *ngIf="row.rpm.plan && row.billing[3].eligibility.last?.count > 1" class="highlighted-cell">
                            {{ row.billing[3].eligibility.last?.timestamp | amDateFormat:'MM/DD/YYYY' }}
                        </span>
                        <span *ngIf="!row.rpm.plan && billingIndex < 2" class="no-highlight">{{ 'GLOBAL.NA' | translate }}</span>
                    </div>

                    <div *ngIf="row.rpm.isActive; else emptyDiv" fxFlex fxLayout="row" fxLayoutAlign="center center" fxLayoutGap="10px">
                        <ng-container *ngIf="(row.billing[3].eligibility.next && row.billing[3].eligibility.next.alreadyEligibleCount < 1) || row.billing[3].hasCodeRequirements || row.billing[3].remainingDays">
                            <ccr-rpm-dependency-icon
                            [matTooltip]="'RPM.DEPENDENCY_ICON_DESCRIPTION' | translate:{code: '99458 x1'}"
                            [size]="40"
                            text="99458 x1">
                            </ccr-rpm-dependency-icon>
                        </ng-container>

                        <ccr-rpm-calendar-icon
                        *ngIf="row.billing[3].remainingDays"
                        [matTooltip]="'RPM.CALENDAR_ICON_DESCRIPTION' | translate:{amount: row.billing[3].remainingDays}"
                        [size]="40"
                        text="{{ row.billing[3].remainingDays }}{{ 'UNIT.DAY_CONDENSED' | translate }}">
                        </ccr-rpm-calendar-icon>

                        <ccr-rpm-clock-icon
                        *ngIf="row.billing[3].eligibility.next?.monitoring?.remaining"
                        [matTooltip]="'RPM.CLOCK_ICON_DESCRIPTION' | translate:{amount: row.billing[3].eligibility.next?.monitoring.remaining}"
                        [size]="40"
                        text="{{ row.billing[3].eligibility.next?.alreadyEligibleCount >= 1 ? row.billing[3].eligibility.next?.monitoring.remaining : 20 }}{{ row.billing[3].eligibility.next?.monitoring.units | translate }}">
                        </ccr-rpm-clock-icon>
                    </div>
                </div>
            </td>
        </tr>
    </tbody>
  </table>
</div>
</div>
</ccr-datasource-overlay>

<ng-template #inactiveIcon>
    <mat-icon>
        cancel
    </mat-icon>
</ng-template>

<ng-template #empty>&nbsp;</ng-template>

<ng-template #emptyDiv>
    <div fxFlex>&nbsp;</div>
</ng-template>