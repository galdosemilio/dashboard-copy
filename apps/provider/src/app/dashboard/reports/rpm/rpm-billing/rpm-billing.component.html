<div class="report-heading">
    <div fxFlex fxLayout="column" fxLayoutAlign="start stretch" fxLayoutGap="10px">
        <div fxLayout="row" fxLayout="start center">
            <mat-icon class="title-icon">receipt</mat-icon>

            <h3 fxLayout="row" fxLayoutAlign="start start" fxLayoutGap="10px">
                <div fxLayout="column" fxLayoutAlign="start start" fxLayoutGap="5px">
                    <span>{{ 'REPORTS.RPM_BILLING_TITLE' | translate }}</span>
                    <small class="count" *ngIf="totalCount"><strong>{{ totalCount }}</strong> {{ 'GLOBAL.PATIENTS' | translate }}</small>
                </div>
                <ccr-walkthrough [autoClose]="false" guide="rpm"></ccr-walkthrough>
            </h3>
        </div>

        <div fxLayout="row" fxLayoutAlign="space-between center" fxLayoutGap="10px">
            <mat-form-field
            [formGroup]="searchForm"
            fxFlex>
                <input
                [placeholder]="'BOARD.FILTER_BY_PATIENT_NAME' | translate"
                formControlName="query"
                matInput
                type="text">
                <mat-icon
                *ngIf="searchForm?.value.query"
                (click)="clearSearchForm()"
                class="clickable"
                matSuffix>cancel</mat-icon>
            </mat-form-field>

            <button
            [disabled]="!source.isLoaded || source.isEmpty"
            (click)="downloadCSV()"
            mat-button class="ccr-align-center">
                {{ 'REPORTS.EXPORT_CSV' | translate }}
                <mat-icon>file_download</mat-icon>
            </button>

            <ccr-page-size-selector
                defaultPageSize="50"
                [defaultPageSizeStorageKey]="defaultPageSizeStorageKey"
                [disabled]="!source.isLoaded"
            ></ccr-page-size-selector>

            <ccr-paginator fxFlex="nogrow" #paginator
            [length]="source.total"
            [pageIndex]="source.pageIndex"
            [pageSize]="source.pageSize"
            (page)="source.pageIndex = $event.pageIndex"
          ></ccr-paginator>
        </div>
    </div>
</div>

<ccr-datasource-overlay class="ccr-table" [source]="source">

    <mat-table
    [dataSource]="source"
    matSort
    matSortActive="anyCodeLastEligibleAt">
        <ng-container cdkColumnDef="index" [sticky]="true">
            <mat-header-cell *cdkHeaderCellDef>&nbsp;&nbsp;&nbsp;#</mat-header-cell>
            <mat-cell *cdkCellDef="let row; let i = index" fxFlex.xs="grow">
                &nbsp;&nbsp;&nbsp;{{ i + source.criteria.offset + 1 }}
            </mat-cell>
        </ng-container>


        <ng-container cdkColumnDef="firstName" [sticky]="true">
            <mat-header-cell *cdkHeaderCellDef mat-sort-header>{{ 'BOARD.FIRST_NAME' | translate }}</mat-header-cell>
            <mat-cell *cdkCellDef="let row" fxLayoutAlign=" center" fxFlex.xs="grow">
                <span>{{ 'BOARD.FIRST_NAME' | translate }}</span>
                <span (click)="openPatientProfile(row)" class="patient-link">{{ row.account.firstName }}</span>
            </mat-cell>
        </ng-container>

        <ng-container cdkColumnDef="lastName" [sticky]="true">
            <mat-header-cell *cdkHeaderCellDef mat-sort-header>{{ 'BOARD.LAST_NAME' | translate }}</mat-header-cell>
            <mat-cell *cdkCellDef="let row" fxLayoutAlign=" center" fxFlex.xs="grow">
                <span>{{ 'BOARD.LAST_NAME' | translate }}</span>
                <span (click)="openPatientProfile(row)" class="patient-link">{{ row.account.lastName }}</span>
            </mat-cell>
        </ng-container>

        <ng-container cdkColumnDef="deviceSupplied" [sticky]="false">
            <mat-header-cell *cdkHeaderCellDef>{{ 'RPM.DEVICE_TYPE' | translate }}</mat-header-cell>
            <mat-cell *cdkCellDef="let row" fxLayoutAlign=" center" fxFlex.xs="grow">
                <span>{{ 'RPM.DEVICE_TYPE' | translate }}</span>
                <span>{{ row.device?.displayName | translate }}</span>
            </mat-cell>
        </ng-container>

        <ng-container cdkColumnDef="dob">
            <mat-header-cell *cdkHeaderCellDef>{{ 'BOARD.DOB' | translate }}</mat-header-cell>
            <mat-cell *cdkCellDef="let row" fxLayoutAlign=" center" fxFlex.xs="grow">
                <span>{{ 'BOARD.DOB' | translate }}</span>
                {{ row.account.dateOfBirth | amDateFormat:'MM/DD/YYYY' }}
            </mat-cell>
        </ng-container>

        <ng-container cdkColumnDef="status">
            <mat-header-cell *cdkHeaderCellDef fxLayout="column" fxLayoutAlign="center center" fxLayoutGap="5px">
                <span class="status-filter-label">{{ 'BOARD.STATUS' | translate }}</span>

                <select (change)="onStatusFilterChange($event)">
                    <option value="all">{{ 'LIBRARY.FORMS.ALL' | translate }}</option>
                    <option selected value="active">{{ 'RPM.STATE.ACTIVE' | translate }}</option>
                    <option value="inactive">{{ 'RPM.STATE.INACTIVE' | translate }}</option>
                </select>
            </mat-header-cell>
            <mat-cell *cdkCellDef="let row" fxLayoutAlign="center center" fxFlex.xs="grow">
                <span>{{ 'BOARD.STATUS' | translate }}</span>
                <mat-icon *ngIf="row.rpm.isActive" class="active">
                    check_circle
                </mat-icon>

                <mat-icon *ngIf="!row.rpm.isActive">
                    cancel
                </mat-icon>
            </mat-cell>
        </ng-container>

        <ng-container cdkColumnDef="activationDate">
            <mat-header-cell *cdkHeaderCellDef mat-sort-header="startedAt" [class.dataset-empty]="!source.result?.length" class="first" fxLayoutAlign="center center">
                <div fxLayout="column" fxLayoutAlign="center center" fxLayoutGap="5px">
                    <small fxLayout="column" fxLayoutAlign="start center">
                        <span class="all-codes-label">{{ 'RPM.ACTIVATION_DATE' | translate }}</span>
                    </small>
                </div>
            </mat-header-cell>
            <mat-cell
            *cdkCellDef="let row; let rowIndex = index"
            [class.last]="rowIndex === source.result.length - 1"
            class="date-highlighted"
            fxLayoutAlign="center center"
            fxFlex.xs="grow">
                <span class="all-codes-label">{{ 'RPM.ACTIVATION_DATE' | translate }}</span>

                {{ row.rpm.isActive ? (row.rpm.changedAt | amDateFormat:'MM/DD/YYYY' ) : '' }}
            </mat-cell>
        </ng-container>

        <ng-container cdkColumnDef="codes">
            <mat-header-cell *cdkHeaderCellDef>
            <div *ngIf="source.result && source.result.length">
            <table class="code-header-table" *ngFor="let billingEntry of source.result[0].billing; let billingIndex = index">
                <tr class="code-header-item">
                    <td colSpan="2" style="text-transform: none;">{{ billingEntry.code === '99458' ? '99458 x1' : billingEntry.code }}</td>
                </tr>
                <tr>
                    <td class="latest-eligible">
                        {{ 'RPM.LATEST_ELIGIBLE_CLAIM' | translate }}
                    </td>

                    <td class="next-claim next-claim-header">
                        {{ 'RPM.NEXT_CLAIM' | translate }}
                    </td>
                </tr>
            </table>
            <table class="code-header-table">
                <tr class="code-header-item last">
                    <td colSpan="2" style="text-transform: none;">99458 x2</td>
                </tr>
                <tr>
                    <td class="latest-eligible">
                        {{ 'RPM.LATEST_ELIGIBLE_CLAIM' | translate }}
                    </td>

                    <td class="next-claim next-claim-header last">
                        {{ 'RPM.NEXT_CLAIM' | translate }}
                    </td>
                </tr>
            </table>
            </div>
            </mat-header-cell>
            <mat-cell
            *cdkCellDef="let row; let rowIndex = index"
            fxLayoutAlign=" center"
            fxFlex.xs="grow">
            <span>{{ 'RPM.LATEST_ELIGIBLE_CLAIM' | translate }}</span>

            <div *ngIf="source.result && source.result.length">
            <table
            *ngFor="let billingEntry of source.result[0].billing; let billingIndex = index" class="code-header-table"
            [class.last]="rowIndex === source.result.length - 1">
                <tr>
                <td class="latest-eligible date-highlighted">
                    <span *ngIf="row.rpm.plan">
                        {{ row.billing[billingIndex].eligibility.last?.timestamp | amDateFormat:'MM/DD/YYYY' }}
                    </span>
                    <span *ngIf="!row.rpm.plan && billingIndex < 2" class="no-highlight">{{ 'GLOBAL.NA' | translate }}</span>
                </td>

                <td *ngIf="!row.rpm.isActive"
                class="next-claim"
                fxLayout="row"
                fxLayoutAlign="center center"
                fxLayoutGap="10px">&nbsp;</td>

                <td
                *ngIf="row.rpm.isActive"
                class="next-claim"
                fxLayout="row"
                fxLayoutAlign="center center"
                fxLayoutGap="10px">
                &nbsp;
                <span *ngFor="let codeRequirement of row.billing[billingIndex].eligibility.next?.relatedCodeRequirementsNotMet">
                    <ccr-rpm-dependency-icon
                    [matTooltip]="'RPM.DEPENDENCY_ICON_DESCRIPTION' | translate:{code: codeRequirement}"
                    [size]="40"
                    [text]="codeRequirement">
                    </ccr-rpm-dependency-icon>
                </span>

                <span *ngIf="!row.rpm.plan && billingIndex < 2" class="no-next-claim">{{ 'GLOBAL.NA' | translate }}</span>

                <ccr-rpm-calendar-icon
                *ngIf="row.billing[billingIndex].remainingDays"
                [matTooltip]="'RPM.CALENDAR_ICON_DESCRIPTION' | translate:{amount: row.billing[billingIndex].remainingDays}"
                [size]="40"
                text="{{ row.billing[billingIndex].remainingDays }}{{ 'UNIT.DAY_CONDENSED' | translate }}">
                </ccr-rpm-calendar-icon>

                <ccr-rpm-clock-icon
                *ngIf="(billingEntry.code !== '99458' || row.billing[billingIndex].eligibility.next?.alreadyEligibleCount < 1) && row.billing[billingIndex].eligibility.next?.monitoring?.remaining"
                [matTooltip]="'RPM.CLOCK_ICON_DESCRIPTION' | translate:{amount: row.billing[billingIndex].eligibility.next?.monitoring.remaining}"
                [size]="40"
                text="{{ row.billing[billingIndex].eligibility.next?.monitoring.remaining }}{{ row.billing[billingIndex].eligibility.next?.monitoring.units | translate }}">
                </ccr-rpm-clock-icon>

                <ccr-rpm-scale-icon
                *ngIf="row.billing[billingIndex].eligibility.next?.transmissions?.remaining"
                [matTooltip]="'RPM.SCALE_ICON_DESCRIPTION' | translate:{amount: row.billing[billingIndex].eligibility.next?.transmissions.remaining}"
                [size]="40"
                text="{{ row.billing[billingIndex].eligibility.next?.transmissions.remaining }}">
                </ccr-rpm-scale-icon>

                <ccr-rpm-chat-icon
                *ngIf="row.billing[billingIndex].eligibility.next?.liveInteraction?.remaining"
                [matTooltip]="'RPM.CHAT_ICON_DESCRIPTION' | translate:{amount: row.billing[billingIndex].eligibility.next?.liveInteraction.remaining}"
                [size]="40"
                text="{{ row.billing[billingIndex].eligibility.next?.liveInteraction.remaining }}">
                </ccr-rpm-chat-icon>
                </td>
                </tr>
            </table>

            <table [class.last]="rowIndex === source.result.length - 1" class="code-header-table">
                <tr>
                <td class="latest-eligible date-highlighted">
                    <span *ngIf="row.rpm.plan && row.billing[3].eligibility.last?.count > 1">
                        {{ row.billing[3].eligibility.last?.timestamp | amDateFormat:'MM/DD/YYYY' }}
                    </span>
                    <span *ngIf="!row.rpm.plan && billingIndex < 2" class="no-highlight">{{ 'GLOBAL.NA' | translate }}</span>
                </td>

                <td *ngIf="!row.rpm.isActive"
                class="next-claim"
                fxLayout="row"
                fxLayoutAlign="center center"
                fxLayoutGap="10px">&nbsp;</td>

                <td
                *ngIf="row.rpm.isActive"
                class="next-claim last"
                fxLayout="row"
                fxLayoutAlign="center center"
                fxLayoutGap="10px">
                &nbsp;
                <span *ngIf="(row.billing[3].eligibility.next && row.billing[3].eligibility.next.alreadyEligibleCount < 1) || row.billing[3].hasCodeRequirements || row.billing[3].remainingDays">
                    <ccr-rpm-dependency-icon
                    [matTooltip]="'RPM.DEPENDENCY_ICON_DESCRIPTION' | translate:{code: '99458 x1'}"
                    [size]="40"
                    text="99458 x1">
                    </ccr-rpm-dependency-icon>
                </span>

                <ccr-rpm-calendar-icon
                *ngIf="row.billing[3].remainingDays"
                [matTooltip]="'RPM.CALENDAR_ICON_DESCRIPTION' | translate:{amount: row.billing[3].remainingDays}"
                [size]="40"
                text="{{ row.billing[3].remainingDays }}{{ 'UNIT.DAY_CONDENSED' | translate }}">
                </ccr-rpm-calendar-icon>

                <ccr-rpm-clock-icon
                *ngIf="row.billing[3].eligibility.next?.monitoring?.remaining"
                [matTooltip]="'RPM.CLOCK_ICON_DESCRIPTION' | translate:{amount: row.billing[3].eligibility.next?.monitoring.remaining}"
                [size]="40"
                text="{{ row.billing[3].eligibility.next?.alreadyEligibleCount >= 1 ? row.billing[3].eligibility.next?.monitoring.remaining : 20 }}{{ row.billing[3].eligibility.next?.monitoring.units | translate }}">
                </ccr-rpm-clock-icon>
                </td>
                </tr>
            </table>
            </div>
            </mat-cell>
        </ng-container>

        <mat-header-row *cdkHeaderRowDef="columns"></mat-header-row>
        <mat-row fxLayoutWrap
        *cdkRowDef="let row; columns: columns; let even = even; let odd = odd"
        [ngClass]="{ 'row-even': even, 'row-odd': odd }"
        ></mat-row>
    </mat-table>

</ccr-datasource-overlay>