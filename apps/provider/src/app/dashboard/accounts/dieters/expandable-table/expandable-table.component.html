<ccr-datasource-overlay
[emptyMsg]="'BOARD.DIETERS_EMPTY_LIST' | translate"
[source]="source"
class="ccr-table ccr-expand-table ccr-table-stats">

<div class="ccr-expandable-table-container">
<div class="ccr-expandable-table">
  <table ccrTableSort>
    <thead>
      <tr>
        <td class="column-firstname">
          <div>
            <ccr-table-sort-header property="firstName">
              <span>{{ 'BOARD.FIRST_NAME' | translate }}</span>
            </ccr-table-sort-header>
          </div>
        </td>
        <td class="column-lastname">
          <div>
            <ccr-table-sort-header property="lastName" fxFlex>
              <span>{{ 'BOARD.LAST_NAME' | translate }}</span>
            </ccr-table-sort-header>
          </div>
        </td>
        <td class="column-startweight">
          <div>
            <ccr-table-sort-header property="weight.first.value">
              <span>{{ 'BOARD.START_WEIGHT' | translate }}</span>
            </ccr-table-sort-header>
          </div>
        </td>
        <td class="column-currentweight">
          <div>
            <ccr-table-sort-header property="weight.last.value">
              <span>{{ 'BOARD.CURRENT_WEIGHT' | translate }}</span>
            </ccr-table-sort-header>
          </div>
        </td>
        <td class="column-weightchange">
          <div>
            <ccr-table-sort-header property="weight.change.value">
              <span>{{ 'STATS.WEIGHT_CHANGE' | translate }}</span>
            </ccr-table-sort-header>
          </div>
        </td>
        <td class="column-weightchangepercent">
          <div>
            <ccr-table-sort-header property="weight.change.percentage">
              <span>{{ 'STATS.WEIGHT_CHANGE_PERCENT' | translate }}</span>
            </ccr-table-sort-header>
          </div>
        </td>
        <td class="column-startdate">
          <div>
            <ccr-table-sort-header property="startedAt">
              <span>{{ 'BOARD.START_DATE' | translate }}</span>
              &nbsp;
              <ccr-popup-description
              [title]="'BOARD.START_DATE' | translate"
              [description]="'BOARD.START_DATE_DESCRIPTION' | translate"
              ></ccr-popup-description>
            </ccr-table-sort-header>
          </div>
        </td>
        <td class="column-startweightdate">
          <div>
            <ccr-table-sort-header property="weight.first.recordedAt">
              <span>{{ 'BOARD.START_WEIGHT_DATE' | translate }}</span>
            </ccr-table-sort-header>
          </div>
        </td>
        <td class="column-currentweightdate">
          <div>
            <ccr-table-sort-header property="weight.last.recordedAt">
              <span>{{ 'BOARD.CURRENT_WEIGHT_DATE' | translate }}</span>
            </ccr-table-sort-header>
          </div>
        </td>
        <td class="column-actions">{{ 'BOARD.ACTIONS' | translate }}</td>
      </tr>
    </thead>
    <tbody>
    <tr
    *ngFor="let row of rows; let i = index;"
    class="level{{row.level}}"
    [ngClass]="{
      'row-even': i % 2 === 0,
      'row-odd': i % 2 === 1,
      'hidden': row.isHidden,
      'row-expanded': row.isExpanded,
      'row-nested': row.level > 0,
      'row-bottom-border': row.level > 1,
      'last-of-group': row.isLastOfGroup
    }">
      <td class="column-firstname" [attr.colspan]="row.level >= 1 ? 9 : 1">
        <app-patient-firstname-cell
          [row]="row"
          (toggleRow)="toggleRow($event)"
          (showDieter)="showDieter($event)"
          (onLoadMore)="onLoadMore($event, i)">
        </app-patient-firstname-cell>
      </td>
      <td *ngIf="row.level === 0" class="column-lastname">{{ row.lastName }}</td>
      <td *ngIf="row.level === 0" class="column-startweight">
        <div>
          <ng-container
          [ngTemplateOutlet]="row.weight?.start?.value ? weightreg : empty"
          [ngTemplateOutletContext]="{weight: row.weight, weightValue: row.weight?.start?.value}"></ng-container>
        </div>
      </td>
      <td *ngIf="row.level === 0" class="column-currentweight">
        <div>
          <ng-container
          [ngTemplateOutlet]="row.weight?.end?.value ? weightreg : empty"
          [ngTemplateOutletContext]="{weight: row.weight, weightValue: row.weight?.end?.value}"></ng-container>
        </div>
      </td>
      <td *ngIf="row.level === 0" class="column-weightchange">
        <div>
          <ng-container
          [ngTemplateOutlet]="row.weight?.change?.value ? weightreg : empty"
          [ngTemplateOutletContext]="{weight: row.weight, weightValue: row.weight?.change?.value}"></ng-container>
        </div>
      </td>
      <td *ngIf="row.level === 0" class="column-weightchangepercent">
        <div>
          <div>
          <ng-container
          [ngTemplateOutlet]="row.weight?.change?.percent ? weightpercent : empty"
          [ngTemplateOutletContext]="{weightPercent: row.weight?.change?.percent}"></ng-container>
          </div>
        </div>
      </td>
      <td *ngIf="row.level === 0" class="column-startdate">
        <div data-cy="startDate">
          <ng-container
          [ngTemplateOutlet]="row.startedAt ? longdatereg : empty"
          [ngTemplateOutletContext]="{date: row.startedAt, totalDays: row.totalDays}"></ng-container>
        </div>
      </td>
      <td *ngIf="row.level === 0" class="column-startweightdate">
        <div>
          <ng-container
          [ngTemplateOutlet]="row.weight?.start?.date ? datereg : empty"
          [ngTemplateOutletContext]="{date: row.weight?.start?.date}"></ng-container>
        </div>
      </td>
      <td *ngIf="row.level === 0" class="column-currentweightdate">
        <div>
          <ng-container
          [ngTemplateOutlet]="row.weight?.end?.date ? datereg : empty"
          [ngTemplateOutletContext]="{date: row.weight?.end?.date}"></ng-container>
        </div>
      </td>
      <td class="column-actions">
        <div *ngIf="row.level === 0">
          <button
          [title]="'BOARD.OPEN_IN_NEW' | translate"
          (click)="showDieter(row, true)"
          mat-icon-button>
            <mat-icon>open_in_new</mat-icon>
          </button>
          <button
          [title]="'GLOBAL.EDIT' | translate"
          (click)="onEdit(row)"
          mat-icon-button>
            <mat-icon>edit</mat-icon>
          </button>
          <button
          *ngIf="hasAdmin"
          [title]="'BOARD.REMOVE' | translate"
          (click)="onRemove(row)"
          mat-icon-button><mat-icon>delete</mat-icon></button>
        </div>
      </td>
    </tr>
    </tbody>
  </table>
</div>
</div>
</ccr-datasource-overlay>

<ng-template #weightpercent let-weightPercent="weightPercent">
  {{ weightPercent.toFixed(1) }}
  <small>%</small>
</ng-template>

<ng-template #weightreg let-weight="weight" let-weightValue="weightValue">
  {{ weightValue | unitConversion: 'composition' : 1 }}
  <small>{{ 'composition' | unitLabel: weight | translate }}</small>
</ng-template>

<ng-template #longdatereg let-date="date" let-totalDays="totalDays">
    {{ date | amUtc | amDateFormat:'MMM D, YYYY' }}&nbsp;
    ({{ totalDays }} {{ 'UNIT.DAYS' | translate }})
</ng-template>

<ng-template #datereg let-date="date">{{ date | amDateFormat:'MMM D, YYYY' }}</ng-template>

<ng-template #empty>
  <div>-</div>
</ng-template>